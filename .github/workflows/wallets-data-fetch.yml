name: Fetch and Compare Wallets Data

on:
  push:
    branches:
      - dev-walletConnectImprovs

jobs:
  check-wallets-update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Fetch new wallets data
        id: fetch
        run: |
          echo "Fetching wallets data..."
          status_code=$(curl -s -w "%{http_code}" -o new_walletsData.json https://example.com/walletsData.json)
          echo "HTTP Status: $status_code"

          if [ "$status_code" -ne 200 ]; then
            echo "❌ Failed to fetch wallets data (HTTP $status_code)"
            cat new_walletsData.json || echo "No data to display."
            exit 1
          fi

          # Validate JSON
          if ! jq empty new_walletsData.json 2>/dev/null; then
            echo "❌ Invalid JSON received!"
            cat new_walletsData.json
            exit 1
          fi

      - name: Compare with current walletsData.json
        id: compare_wallets
        run: |
          echo "Comparing new data with current..."
          if cmp -s "public/walletsData.json" "new_walletsData.json"; then
            echo "✅ No changes in wallets data."
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "⚠️ Wallets data has changed."
            mv new_walletsData.json public/walletsData.json
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Create or update pull request
        if: steps.compare_wallets.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "chore: update walletsData.json"
          title: "chore: update walletsData.json"
          body: |
            This PR updates `public/walletsData.json` with the latest fetched data.

            Auto-updated by GitHub Actions. Replaces older PRs using the same branch.
          branch: update-wallets-data
          base: dev-walletConnectImprovs
          delete-branch: true
