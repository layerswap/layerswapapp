name: Auto-update walletsData.json

on:
  push:
    branches:
      - dev-walletConnectImprovs

jobs:
  update-wallets-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Fetch new wallets data
        id: fetch
        run: |
          echo "📦 Fetching walletsData.json..."
          curl --fail -s -o new_walletsData.json https://explorer-api.walletconnect.com/v3/wallets?projectId=4b988e37fe730153d49f1ecb64fbbaa7

          echo "📄 Fetched content:"
          cat new_walletsData.json

          if [ ! -s new_walletsData.json ]; then
            echo "❌ Downloaded file is empty!"
            exit 1
          fi

          if ! jq empty new_walletsData.json > /dev/null 2>&1; then
            echo "❌ Invalid JSON in downloaded file!"
            cat new_walletsData.json
            exit 1
          fi

      - name: Compare downloaded vs current (semantic)
        id: compare_wallets
        run: |
          echo "🔍 Comparing JSON semantically..."
          jq --sort-keys . public/walletsData.json > current.json
          jq --sort-keys . new_walletsData.json > fetched.json

          if diff -q current.json fetched.json > /dev/null; then
            echo "✅ No semantic changes."
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "🔁 Detected change in content."
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

          # Clean up normalized comparison files
          rm -f current.json fetched.json

      - name: Overwrite public/walletsData.json using Node
        if: steps.compare_wallets.outputs.changed == 'true'
        run: |
          node -e "require('fs').copyFileSync('new_walletsData.json', 'public/walletsData.json')"

      - name: Clean up downloaded file
        run: rm -f new_walletsData.json

      - name: Create or update pull request
        if: steps.compare_wallets.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "chore: update walletsData.json"
          title: "chore: update walletsData.json"
          body: |
            This PR updates `public/walletsData.json` with new content fetched from the source.

            Changes are only committed when actual JSON structure or values change (ignoring formatting).
          branch: update-wallets-data
          base: dev-walletConnectImprovs
          delete-branch: true
