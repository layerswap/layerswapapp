"use strict";(self.webpackChunklayerswap=self.webpackChunklayerswap||[]).push([[280],{"./node_modules/@solana/wallet-adapter-ledger/node_modules/@ledgerhq/hw-transport-webhid/lib-es/TransportWebHID.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:()=>TransportWebHID});var Transport=__webpack_require__("./node_modules/@ledgerhq/hw-transport/lib-es/Transport.js"),lib_es=__webpack_require__("./node_modules/@ledgerhq/errors/lib-es/index.js"),Buffer=__webpack_require__("./node_modules/buffer/index.js").Buffer;function asUInt16BE(value){const b=Buffer.alloc(2);return b.writeUInt16BE(value,0),b}const initialAcc={data:Buffer.alloc(0),dataLength:0,sequence:0},hid_framing=(channel,packetSize)=>({makeBlocks(apdu){let data=Buffer.concat([asUInt16BE(apdu.length),apdu]);const blockSize=packetSize-5,nbBlocks=Math.ceil(data.length/blockSize);data=Buffer.concat([data,Buffer.alloc(nbBlocks*blockSize-data.length+1).fill(0)]);const blocks=[];for(let i=0;i<nbBlocks;i++){const head=Buffer.alloc(5);head.writeUInt16BE(channel,0),head.writeUInt8(5,2),head.writeUInt16BE(i,3);const chunk=data.slice(i*blockSize,(i+1)*blockSize);blocks.push(Buffer.concat([head,chunk]))}return blocks},reduceResponse(acc,chunk){let{data,dataLength,sequence}=acc||initialAcc;if(chunk.readUInt16BE(0)!==channel)throw new lib_es.wX("Invalid channel","InvalidChannel");if(5!==chunk.readUInt8(2))throw new lib_es.wX("Invalid tag","InvalidTag");if(chunk.readUInt16BE(3)!==sequence)throw new lib_es.wX("Invalid sequence","InvalidSequence");acc||(dataLength=chunk.readUInt16BE(5)),sequence++;const chunkData=chunk.slice(acc?5:7);return data=Buffer.concat([data,chunkData]),data.length>dataLength&&(data=data.slice(0,dataLength)),{data,dataLength,sequence}},getReducedResult(acc){if(acc&&acc.dataLength===acc.data.length)return acc.data}});var semver=__webpack_require__("./node_modules/semver/index.js"),semver_default=__webpack_require__.n(semver);var DeviceModelId;!function(DeviceModelId){DeviceModelId.blue="blue",DeviceModelId.nanoS="nanoS",DeviceModelId.nanoSP="nanoSP",DeviceModelId.nanoX="nanoX",DeviceModelId.stax="stax",DeviceModelId.europa="europa",DeviceModelId.apex="apex"}(DeviceModelId||(DeviceModelId={}));const devices={[DeviceModelId.blue]:{id:DeviceModelId.blue,productName:"Ledger Blue",productIdMM:0,legacyUsbProductId:0,usbOnly:!0,memorySize:491520,masks:[822083584,822149120],getBlockSize:_firwareVersion=>4096},[DeviceModelId.nanoS]:{id:DeviceModelId.nanoS,productName:"Ledger Nano S",productIdMM:16,legacyUsbProductId:1,usbOnly:!0,memorySize:327680,masks:[823132160],getBlockSize:firmwareVersion=>semver_default().lt(semver_default().coerce(firmwareVersion)??"","2.0.0")?4096:2048},[DeviceModelId.nanoX]:{id:DeviceModelId.nanoX,productName:"Ledger Nano X",productIdMM:64,legacyUsbProductId:4,usbOnly:!1,memorySize:2097152,masks:[855638016],getBlockSize:_firwareVersion=>4096,bluetoothSpec:[{serviceUuid:"13d63400-2c97-0004-0000-4c6564676572",notifyUuid:"13d63400-2c97-0004-0001-4c6564676572",writeUuid:"13d63400-2c97-0004-0002-4c6564676572",writeCmdUuid:"13d63400-2c97-0004-0003-4c6564676572"}]},[DeviceModelId.nanoSP]:{id:DeviceModelId.nanoSP,productName:"Ledger Nano S Plus",productIdMM:80,legacyUsbProductId:5,usbOnly:!0,memorySize:1569792,masks:[856686592],getBlockSize:_firmwareVersion=>32},[DeviceModelId.apex]:{id:DeviceModelId.apex,productName:"Ledger Nano Gen5",productIdMM:128,legacyUsbProductId:8,usbOnly:!1,memorySize:1569792,masks:[859832320],getBlockSize:_firmwareVersion=>32,bluetoothSpec:[{serviceUuid:"13d63400-2c97-8004-0000-4c6564676572",notifyUuid:"13d63400-2c97-8004-0001-4c6564676572",writeUuid:"13d63400-2c97-8004-0002-4c6564676572",writeCmdUuid:"13d63400-2c97-8004-0003-4c6564676572"}]},[DeviceModelId.stax]:{id:DeviceModelId.stax,productName:"Ledger Stax",productIdMM:96,legacyUsbProductId:6,usbOnly:!1,memorySize:1569792,masks:[857735168],getBlockSize:_firmwareVersion=>32,bluetoothSpec:[{serviceUuid:"13d63400-2c97-6004-0000-4c6564676572",notifyUuid:"13d63400-2c97-6004-0001-4c6564676572",writeUuid:"13d63400-2c97-6004-0002-4c6564676572",writeCmdUuid:"13d63400-2c97-6004-0003-4c6564676572"}]},[DeviceModelId.europa]:{id:DeviceModelId.europa,productName:"Ledger Flex",productIdMM:112,legacyUsbProductId:7,usbOnly:!1,memorySize:1569792,masks:[858783744],getBlockSize:_firmwareVersion=>32,bluetoothSpec:[{serviceUuid:"13d63400-2c97-3004-0000-4c6564676572",notifyUuid:"13d63400-2c97-3004-0001-4c6564676572",writeUuid:"13d63400-2c97-3004-0002-4c6564676572",writeCmdUuid:"13d63400-2c97-3004-0003-4c6564676572"}]}},devicesList=(DeviceModelId.blue,DeviceModelId.nanoS,DeviceModelId.nanoSP,DeviceModelId.nanoX,DeviceModelId.stax,DeviceModelId.europa,Object.values(devices)),identifyUSBProductId=usbProductId=>{const legacy=devicesList.find(d=>d.legacyUsbProductId===usbProductId);if(legacy)return legacy;const mm=usbProductId>>8;return devicesList.find(d=>d.productIdMM===mm)},bluetoothServices=[],serviceUuidToInfos={};for(const id in devices){const deviceModel=devices[id],{bluetoothSpec}=deviceModel;if(bluetoothSpec)for(let i=0;i<bluetoothSpec.length;i++){const spec=bluetoothSpec[i];bluetoothServices.push(spec.serviceUuid),serviceUuidToInfos[spec.serviceUuid]=serviceUuidToInfos[spec.serviceUuid.replace(/-/g,"")]={deviceModel,...spec}}}var logs_lib_es=__webpack_require__("./node_modules/@ledgerhq/logs/lib-es/index.js"),TransportWebHID_Buffer=__webpack_require__("./node_modules/buffer/index.js").Buffer;const ledgerDevices=[{vendorId:11415}],isSupported=()=>Promise.resolve(!(!window.navigator||!window.navigator.hid)),getHID=()=>{const{hid}=navigator;if(!hid)throw new lib_es.wX("navigator.hid is not supported","HIDNotSupported");return hid};async function requestLedgerDevices(){const device=await getHID().requestDevice({filters:ledgerDevices});return Array.isArray(device)?device:[device]}async function getLedgerDevices(){return(await getHID().getDevices()).filter(d=>11415===d.vendorId)}class TransportWebHID extends Transport.Ay{device;deviceModel;channel=Math.floor(65535*Math.random());packetSize=64;constructor(device){super(),this.device=device,this.deviceModel="number"==typeof device.productId?identifyUSBProductId(device.productId):void 0,device.addEventListener("inputreport",this.onInputReport)}inputs=[];inputCallback;read=()=>this.inputs.length?Promise.resolve(this.inputs.shift()):new Promise(success=>{this.inputCallback=success});onInputReport=e=>{const buffer=TransportWebHID_Buffer.from(e.data.buffer);this.inputCallback?(this.inputCallback(buffer),this.inputCallback=null):this.inputs.push(buffer)};static isSupported=isSupported;static list=getLedgerDevices;static listen=observer=>{let unsubscribed=!1;return async function getFirstLedgerDevice(){const existingDevices=await getLedgerDevices();return existingDevices.length>0?existingDevices[0]:(await requestLedgerDevices())[0]}().then(device=>{if(device){if(!unsubscribed){const deviceModel="number"==typeof device.productId?identifyUSBProductId(device.productId):void 0;observer.next({type:"add",descriptor:device,deviceModel}),observer.complete()}}else observer.error(new lib_es.kt("Access denied to use Ledger device"))},error=>{observer.error(new lib_es.kt(error.message))}),{unsubscribe:function unsubscribe(){unsubscribed=!0}}};static async request(){const[device]=await requestLedgerDevices();return TransportWebHID.open(device)}static async openConnected(){const devices=await getLedgerDevices();return 0===devices.length?null:TransportWebHID.open(devices[0])}static async open(device){await device.open();const transport=new TransportWebHID(device),onDisconnect=e=>{device===e.device&&(getHID().removeEventListener("disconnect",onDisconnect),transport._emitDisconnect(new lib_es.Ej))};return getHID().addEventListener("disconnect",onDisconnect),transport}_disconnectEmitted=!1;_emitDisconnect=e=>{this._disconnectEmitted||(this._disconnectEmitted=!0,this.emit("disconnect",e))};async close(){await this.exchangeBusyPromise,this.device.removeEventListener("inputreport",this.onInputReport),await this.device.close()}exchange=async apdu=>await this.exchangeAtomicImpl(async()=>{const{channel,packetSize}=this;(0,logs_lib_es.Rm)("apdu","=> "+apdu.toString("hex"));const framing=hid_framing(channel,packetSize),blocks=framing.makeBlocks(apdu);for(let i=0;i<blocks.length;i++)await this.device.sendReport(0,blocks[i]);let result,acc;for(;!(result=framing.getReducedResult(acc));)try{const buffer=await this.read();acc=framing.reduceResponse(acc,buffer)}catch(e){if(e instanceof lib_es.wX&&"InvalidChannel"===e.id)continue;throw e}return(0,logs_lib_es.Rm)("apdu","<= "+result.toString("hex")),result}).catch(e=>{if(e&&e.message&&e.message.includes("write"))throw this._emitDisconnect(e),new lib_es.iX(e.message);throw e});setScrambleKey(){}}}}]);